<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SkillXpress | Micro-Cognitive Test</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(120deg, #eef2ff, #ecfeff);
      font-family: 'Segoe UI', sans-serif;
    }

    .card-box {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }

    .hidden {
      display: none;
    }

    .timer {
      font-weight: 800;
      color: #dc2626;
    }
  </style>
</head>
<body>

<div class="container d-flex align-items-center justify-content-center min-vh-100">

  <!-- ================= INSTRUCTIONS SCREEN ================= -->
  <div id="instructions" class="card-box col-lg-7 col-md-9">
    <h3 class="mb-3">üß† Micro-Cognitive & Behaviour Test</h3>

    <p class="text-muted">
      This monthly test evaluates your thinking ability, decision-making,
      adaptability, accuracy, and behaviour. It is not syllabus-based.
    </p>

    <ul class="mt-3">
      <li>‚è± Duration: <b>20 minutes</b></li>
      <li>üìã Total Questions: <b>40</b></li>
      <li>üìÖ Attempt allowed: <b>Once per month</b></li>
      <li>üö´ No backtracking after submission</li>
      <li>‚ö† Do not refresh the page during the test</li>
    </ul>

    <div class="form-check mt-4">
      <input class="form-check-input" type="checkbox" id="agreeCheck">
      <label class="form-check-label">
        I have read and understood the instructions
      </label>
    </div>

    <button class="btn btn-primary w-100 mt-4" onclick="startTest()">
      Start Test
    </button>
  </div>

  <!-- ================= TEST SCREEN ================= -->
  <div id="testScreen" class="card-box col-lg-9 col-md-11 hidden">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>üß† Micro-Cognitive Test</h4>
      <div class="timer">
        Time Left: <span id="timer">20:00</span>
      </div>
    </div>

    <div id="questions"></div>


    <button class="btn btn-success mt-4" onclick="submitTest()">
  Submit Test
</button>

  </div>

</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
  let answers = {};

/* ================= AUTH CHECK ================= */
async function checkAuth() {
  const { data } = await supabaseClient.auth.getUser();
  if (!data.user) {
    window.location.href = "index.html";
  }
}
checkAuth();

/* ================= MONTHLY ATTEMPT CHECK ================= */
async function checkMonthlyAttempt() {
  // üîì DEV MODE (temporary)
  // Abhi backend ready nahi hai, isliye test allow kar rahe hain
  return false;
}



async function startTest() {
  const agreed = document.getElementById("agreeCheck").checked;
  if (!agreed) {
    alert("Please agree to the instructions before starting the test.");
    return;
  }

  const attempted = await checkMonthlyAttempt();
  if (attempted) {
    alert("‚ùå You have already attempted this month's Micro-Cognitive Test.");
    return;
  }

  document.getElementById("instructions").classList.add("hidden");
  document.getElementById("testScreen").classList.remove("hidden");

  startTimer();      // ‚è± timer
  loadQuestions();   // üìã questions
}

/* ================= TIMER START ================= */
let totalSeconds = 20 * 60; // 20 minutes
let timerInterval;

function startTimer() {
  timerInterval = setInterval(() => {
    totalSeconds--;

    const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
    const seconds = String(totalSeconds % 60).padStart(2, "0");

    document.getElementById("timer").innerText = `${minutes}:${seconds}`;

    if (totalSeconds <= 0) {
      clearInterval(timerInterval);
      alert("Time is up! Test will be submitted automatically.");
      submitTest();
    }
  }, 1000);
}


/* ================= END TEST ================= */
function endTest() {
  submitTest(); // auto submit
}


/* ================= LOAD QUESTIONS ================= */
async function loadQuestions() {
  const { data, error } = await supabaseClient
    .from("micro_test_questions")
    .select("*")
    .limit(40);

  if (error) {
    document.getElementById("questions").innerHTML =
      "<div class='alert alert-danger'>Failed to load questions</div>";
    return;
  }

  const container = document.getElementById("questions");
  container.innerHTML = "";

  data.forEach((q, index) => {
    container.innerHTML += `
      <div class="card mb-3">
        <div class="card-body">
          <p><b>Q${index + 1}.</b> ${q.question}</p>
          ${q.options.map((opt, i) => `
            <div class="form-check">
              <input class="form-check-input"
                     type="radio"
                      name="${q.id}"
                      value="${i}"
                        onchange="answers['${q.id}'] = ${i}">

              <label class="form-check-label">
                ${opt}
              </label>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  });
}

/* ================= SUBMIT TEST ================= */
async function submitTest() {
  clearInterval(timerInterval);

  const totalAnswered = Object.keys(answers).length;
  if (totalAnswered === 0) {
    alert("Please attempt at least one question");
    return;
  }

  // üîë logged-in user id lo
  const { data } = await supabaseClient.auth.getUser();
  if (!data.user) {
    alert("Session expired, please login again");
    return;
  }

  const payload = {
    user_id: data.user.id,
    answers: answers,
    time_taken_seconds: 20 * 60 - totalSeconds
  };

  try {
    const response = await fetch(
      "https://skillxpress.onrender.com/api/micro-test/submit",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      }
    );

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.error || "Submit failed");
    }

    // ‚úÖ backend se aaya brain efficiency
    window.location.href =
      `micro-test-result.html?score=${result.brainEfficiency}`;

  } catch (err) {
    console.error(err);
    alert("‚ùå Backend call failed");
  }
}




</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
