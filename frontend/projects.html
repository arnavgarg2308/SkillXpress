<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projects | SkillXpress</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:#f3f4f6;
  font-family:"Segoe UI",sans-serif;
}
.post-card{
  border:none;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.post-img{
  width:100%;
  height:260px;           /* üî• fixed half-card height */
  object-fit:cover;
  border-radius:14px;
}

.action-btn{
  cursor:pointer;
  font-weight:600;
  color:#374151;
}
.action-btn:hover{
  color:#4f46e5;
}
.comment{
  background:#f9fafb;
  border-radius:10px;
  padding:6px 10px;
  margin-top:6px;
}
.fab{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#4f46e5;
  color:white;
  border:none;
  width:60px;
  height:60px;
  border-radius:50%;
  font-size:30px;
}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:60px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}
.bottom-nav div{
  text-align:center;
  font-size:20px;
  cursor:pointer;
  color:#555;
}
.bottom-nav span{
  display:block;
  font-size:12px;
  .bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:60px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}
.bottom-nav div{
  text-align:center;
  font-size:20px;
  cursor:pointer;
  color:#555;
}
.bottom-nav span{
  display:block;
  font-size:12px;
}

}

</style>
</head>

<body>

<div class="container py-4" style="max-width:720px">

  <h3 class="fw-bold mb-3 text-primary">üöÄ Project Feed</h3>

  <!-- üîç SEARCH USERS -->
  <input
    type="text"
    id="userSearch"
    class="form-control mb-4"
    placeholder="Search users by username or email"
    oninput="searchUsers()"
  />
  <div id="searchResults" class="mb-3"></div>

  <div id="feed">
    <p class="text-muted">Loading projects...</p>
  </div>

</div>

<button class="fab" onclick="goUpload()">+</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
function goUpload(){
  window.location.href = "upload-project.html";
}

/* üîç SEARCH USERS */
async function searchUsers(){
  const q = document.getElementById("userSearch").value.trim();
  if(q.length < 3){
    document.getElementById("searchResults").innerHTML = "";
    return;
  }

  const { data, error } = await supabaseClient
    .from("profiles")
    .select("id, username, email")
    .or(`username.ilike.%${q}%,email.ilike.%${q}%`)
    .limit(5);

  const box = document.getElementById("searchResults");
  box.innerHTML = "";

  if(error || !data) return;

  data.forEach(u=>{
    box.innerHTML += `
      <div class="border rounded p-2 mb-1 action-btn"
           onclick="openUser('${u.id}')">
        <strong>${u.username || "User"}</strong><br>
        <small class="text-muted">${u.email}</small>
      </div>`;
  });
}


function openUser(id){
  window.location.href = `user.html?id=${id}`;
}

/* üì• LOAD PROJECTS */
async function loadProjects(){

  const { data:{session} } = await supabaseClient.auth.getSession();

  const { data:projects } = await supabaseClient
    .from("projects")
    .select("*")
    .order("created_at",{ascending:false});

  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  if(!projects || projects.length===0){
    feed.innerHTML = "<p class='text-muted'>No projects yet</p>";
    return;
  }

  for(const p of projects){

    const { data:likes } = await supabaseClient
      .from("project_likes")
      .select("id")
      .eq("project_id",p.id);

    const { data:comments } = await supabaseClient
      .from("project_comments")
      .select("comment")
      .eq("project_id",p.id);

    feed.innerHTML += `
      <div class="card post-card mb-4 p-3">

        ${p.image_url ? `<img src="${p.image_url}" class="post-img mb-3">` : ""}

        <h5 class="fw-bold">${p.title}</h5>
        <p class="text-muted">${p.description || ""}</p>

        <div class="d-flex gap-3 mt-2">
          <span class="action-btn"
      data-like="${p.id}"
      data-count="${likes?.length || 0}"
      onclick="likeProject('${p.id}')">
  ‚ù§Ô∏è ${likes?.length || 0}
</span>

          <span class="action-btn" onclick="toggleComments('${p.id}')">
            üí¨ ${comments?.length || 0}
          </span>
          <span class="action-btn" onclick="requestTeam('${p.id}','${p.owner_id}')">
            ü§ù Create Team
          </span>
        </div>

        <div id="comments-${p.id}" style="display:none" class="mt-3">
          ${(comments||[]).map(c=>`
            <div class="comment">${c.comment}</div>
          `).join("")}

          <input class="form-control mt-2"
            placeholder="Add a comment"
            onkeydown="addComment(event,'${p.id}')">
        </div>

        ${
          session && session.user.id === p.owner_id
          ? `<button class="btn btn-sm btn-outline-danger mt-3"
              onclick="deleteProject('${p.id}')">üóë Delete</button>`
          : ""
        }

      </div>
    `;
  }
}

/* ‚ù§Ô∏è LIKE */
async function likeProject(projectId){
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return alert("Login required");

  const { data:exist } = await supabaseClient
    .from("project_likes")
    .select("id")
    .eq("project_id",projectId)
    .eq("user_id",session.user.id)
    .single();

  if(exist) return;

  await supabaseClient.from("project_likes").insert({
    project_id:projectId,
    user_id:session.user.id
  });

  const span = document.querySelector(`[data-like="${projectId}"]`);
if(span){
  span.innerText = "‚ù§Ô∏è " + (Number(span.dataset.count) + 1);
}

}

/* üí¨ COMMENTS */
function toggleComments(id){
  const box = document.getElementById(`comments-${id}`);
  box.style.display = box.style.display==="none" ? "block":"none";
}

async function addComment(e,projectId){
  if(e.key!=="Enter") return;
  const text = e.target.value.trim();
  if(!text) return;

  const { data:{session} } = await supabaseClient.auth.getSession();

  await supabaseClient.from("project_comments").insert({
  project_id:projectId,
  user_id:session.user.id,
  comment:text
});

// ‚úÖ append comment only
const box = document.getElementById(`comments-${projectId}`);
box.insertAdjacentHTML("beforeend",
  `<div class="comment">${text}</div>`
);
e.target.value = "";

}

/* ü§ù TEAM REQUEST */
async function requestTeam(projectId, ownerId){
  const { data:{session} } = await supabaseClient.auth.getSession();

  await supabaseClient.from("project_team_requests").insert({
    project_id:projectId,
    from_user:session.user.id,
    to_user:ownerId
  });

  alert("Team request sent ü§ù");
}

/* üóë DELETE */
async function deleteProject(projectId){
  if(!confirm("Delete project?")) return;
  await supabaseClient.from("projects").delete().eq("id",projectId);
  loadProjects();
}

loadProjects();
async function goProfile(){
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return alert("Login required");
  window.location.href = `user.html?id=${session.user.id}`;
}
function goProjects(){
  window.location.href = "projects.html";
}
function goInbox(){
  window.location.href = "inbox.html";
}
async function goProfile(){
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return alert("Login required");
  window.location.href = `user.html?id=${session.user.id}`;
}
function goProjects(){
  window.location.href = "projects.html";
}
function goInbox(){
  window.location.href = "inbox.html";
}

</script>
<!-- üîª BOTTOM NAV -->
<div class="bottom-nav">
  <div onclick="goProjects()">üè†<span>Projects</span></div>
  <div onclick="goProfile()">üë§<span>Profile</span></div>
  <div onclick="goInbox()">üí¨<span>Chats</span></div>
</div>

</body>
</html>
