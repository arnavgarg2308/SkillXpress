<!DOCTYPE html>
<html>
<head>
<title>Upload Project</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container py-5">
  <div class="card p-4 mx-auto" style="max-width:500px">
    <h4 class="fw-bold mb-3">ðŸ“¸ New Project</h4>

    <input type="file" id="image" class="form-control mb-2">
    <input type="text" id="title" class="form-control mb-2" placeholder="Project title">
    <textarea id="desc" class="form-control mb-2" placeholder="Caption / Description"></textarea>
    <input type="text" id="tech" class="form-control mb-3" placeholder="Tech stack (comma separated)">

    <button class="btn btn-primary w-100" onclick="uploadProject()">Upload</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
async function uploadProject(){

  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return alert("Login required");

  const file = document.getElementById("image").files[0];
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("desc").value.trim();
  const techStack = document.getElementById("tech").value.trim();

  let imageUrl = null;

  if(file){
    const path = `${session.user.id}/${Date.now()}_${file.name}`;

    const { error: uploadError } = await supabaseClient.storage
      .from("project-images")
      .upload(path, file, { upsert: true });

    if(uploadError){
      alert(uploadError.message);
      return;
    }

    const { data } = supabaseClient
      .storage
      .from("project-images")
      .getPublicUrl(path);

    imageUrl = data.publicUrl;
  }

  const { error } = await supabaseClient
    .from("projects")
    .insert({
      owner_id: session.user.id,
      title: title,
      description: description,
      tech_stack: techStack,
      image_url: imageUrl
    });

  if(error){
    alert(error.message);
    return;
  }

  alert("Project uploaded ðŸš€");
  window.location.href = "projects.html";
}
</script>
</body>
</html>
