<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Job Match | SkillXpress</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:linear-gradient(135deg,#eef2ff,#ffffff);
  font-family:"Segoe UI",sans-serif;
}
.card{
  border:none;
  border-radius:20px;
  box-shadow:0 15px 35px rgba(0,0,0,.1);
}
.badge{
  font-size:0.9rem;
}
.progress{
  height:22px;
  border-radius:12px;
}
.progress-bar{
  font-weight:600;
}
.section-title{
  font-weight:700;
  color:#4f46e5;
}
</style>
</head>

<body>

<div class="container py-5">

  <h2 class="text-center fw-bold text-primary mb-4">
    ðŸŽ¯ Job Readiness Dashboard
  </h2>

  <!-- INTERESTS -->
  <div class="card p-4 mb-4">
    <h5 class="section-title mb-3">ðŸ’¼ Your Dream Roles</h5>
    <div id="interestBox" class="d-flex flex-wrap gap-2">
      <span class="text-muted">Loading interests...</span>
    </div>
  </div>

  <!-- SKILLS -->
  <div class="card p-4 mb-4">
    <h5 class="section-title mb-3">ðŸ§  Your Current Skills</h5>
    <div id="skillBox">
      <span class="text-muted">Loading skills...</span>
    </div>
  </div>

  <!-- JOB MATCH -->
  <div class="card p-4">
    <h5 class="section-title mb-3">ðŸ“Š Job Readiness Percentage</h5>
    <div id="jobResults">
      <span class="text-muted">Calculating job match...</span>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
async function loadJobMatch() {

  /* 1ï¸âƒ£ AUTH */
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if (!session) return alert("Login required");

  /* 2ï¸âƒ£ FETCH PROFILE */
  const { data: profile } = await supabaseClient
    .from("profiles")
    .select("interests, github")
    .eq("id", session.user.id)
    .single();

  if (!profile || !profile.interests || !profile.github) {
    alert("Profile incomplete");
    return;
  }

  /* SHOW INTERESTS */
  const interestBox = document.getElementById("interestBox");
  interestBox.innerHTML = "";
  profile.interests.forEach(i => {
    interestBox.innerHTML += `<span class="badge bg-primary">${i}</span>`;
  });

  /* 3ï¸âƒ£ FETCH SKILLS */
  const githubUsername = profile.github
    .replace("https://", "")
    .replace("http://", "")
    .replace("www.", "")
    .split("github.com/")[1]
    .replace("/", "");

  const skillsRes = await fetch(
    `https://skillxpress.onrender.com/full-skills/${session.user.id}/${githubUsername}`
  );
  const skillData = await skillsRes.json();

  const skillBox = document.getElementById("skillBox");
  skillBox.innerHTML = "";

  Object.entries(skillData.skills).forEach(([skill, value]) => {
    skillBox.innerHTML += `
      <div class="mb-2">
        <strong>${skill}</strong>
        <div class="progress">
          <div class="progress-bar bg-info" style="width:${value}%">
            ${value}%
          </div>
        </div>
      </div>
    `;
  });
const topInterests = profile.interests.slice(0, 4);
  /* 4ï¸âƒ£ JOB MATCH */
  const res = await fetch(
   "https://skillback.onrender.com/api/job-match"
,

    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        skills: skillData.skills,
        interests: topInterests
      })
    }
  );

  const result = await res.json();
const filteredResults = {};
topInterests.forEach(job => {
  if (result.results && result.results[job] !== undefined) {
    filteredResults[job] = result.results[job];
  }
});

renderJobs(filteredResults);

}

/* JOB UI */
function renderJobs(data){
  const container = document.getElementById("jobResults");
  container.innerHTML = "";

  Object.entries(data).forEach(([job, percent]) => {
    container.innerHTML += `
      <div class="mb-4">
        <strong>${job}</strong>
        <div class="progress mt-1">
          <div class="progress-bar bg-success" style="width:${percent}%">
            ${percent}%
          </div>
        </div>
        <small class="text-muted">
          ${100 - percent}% gap to reach this role
        </small>
      </div>
    `;
  });
}

loadJobMatch();
</script>

</body>
</html>
