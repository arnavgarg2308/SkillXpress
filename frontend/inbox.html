<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inbox | SkillXpress</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:#f3f4f6;
  font-family:"Segoe UI",sans-serif;
}
.chat-card{
  background:#fff;
  padding:12px;
  border-radius:14px;
  margin-bottom:10px;
  display:flex;
  gap:12px;
  align-items:center;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  background:#ddd;
}
.chat-info{
  flex:1;
}
.chat-info h6{
  margin:0;
  font-weight:700;
}
.chat-info p{
  margin:0;
  font-size:13px;
  color:#777;
}
.time{
  font-size:11px;
  color:#999;
}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:60px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}
.bottom-nav div{
  text-align:center;
  font-size:20px;
  cursor:pointer;
  color:#555;
}
.bottom-nav span{
  display:block;
  font-size:12px;
}

</style>
</head>

<body>

<div class="container py-4" style="max-width:720px">
  <h4 class="fw-bold mb-3">üí¨ Inbox</h4>
  <div id="chatList">
    <p class="text-muted">Loading chats...</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
async function loadInbox(){
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return;

  const myId = session.user.id;

  // fetch chats involving me
  const { data:chats } = await supabaseClient
    .from("chats")
    .select("*")
    .or(`from_user.eq.${myId},to_user.eq.${myId}`)
    .order("created_at",{ascending:false});

  const box = document.getElementById("chatList");
  box.innerHTML="";

  if(!chats || chats.length===0){
    box.innerHTML="<p class='text-muted'>No chats yet</p>";
    return;
  }

  const seenUsers = new Set();

  for(const c of chats){
    const otherId = c.from_user === myId ? c.to_user : c.from_user;
    if(seenUsers.has(otherId)) continue;
    seenUsers.add(otherId);

    // get other user's profile
    const { data:profile } = await supabaseClient
      .from("profiles")
      .select("id, username")
      .eq("id",otherId)
      .single();

    box.innerHTML += `
      <div class="chat-card" onclick="openChat('${otherId}')">
        <div class="avatar"></div>
        <div class="chat-info">
          <h6>${profile?.username || "User"}</h6>
          <p>${c.message}</p>
        </div>
        <div class="time">
          ${new Date(c.created_at).toLocaleTimeString([],{
            hour:"2-digit",minute:"2-digit"
          })}
        </div>
      </div>
    `;
  }
}

function openChat(userId){
  localStorage.setItem("chatReceiver", userId);
  window.location.href = `chat.html?user=${userId}`;
}

loadInbox();
async function goProfile(){
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return alert("Login required");
  window.location.href = `user.html?id=${session.user.id}`;
}
function goProjects(){
  window.location.href = "projects.html";
}
function goInbox(){
  window.location.href = "inbox.html";
}

</script>
<!-- üîª BOTTOM NAV -->
<div class="bottom-nav">
  <div onclick="goProjects()">üè†<span>Projects</span></div>
  <div onclick="goProfile()">üë§<span>Profile</span></div>
  <div onclick="goInbox()">üí¨<span>Chats</span></div>
</div>

</body>
</html>
