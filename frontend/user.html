<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile | SkillXpress</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:"Segoe UI",sans-serif;
  background:#f3f4f6;
}
.skill-graph-wrapper{
  width:100%;
  height:300px;      /* üëà yahan se size control */
  max-height:320px;
  position:relative;
}
@media(max-width:768px){
  .skill-graph-wrapper{
    height:240px;
  }
}
.card{
  border:none;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.username{
  font-weight:800;
  color:#4f46e5;
}
.chat-btn{
  background:#4f46e5;
  color:white;
  border:none;
  border-radius:12px;
  padding:8px 16px;
}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:60px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}
.bottom-nav div{
  text-align:center;
  font-size:20px;
  cursor:pointer;
  color:#555;
}
.bottom-nav span{
  display:block;
  font-size:12px;
}
</style>
</head>

<body>

<div class="container py-4" style="max-width:900px">

  <!-- PROFILE HEADER -->
  <div class="card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h2 id="username" class="username mb-1">User</h2>
        <p class="text-muted mb-0" id="collegeInfo"></p>
      </div>
      <button id="chatButton" class="chat-btn mt-2 mt-md-0" onclick="openChat()">üí¨ Chat</button>
    </div>
  </div>

  <!-- ACADEMIC DETAILS -->
  <div class="card p-4 mb-4">
    <h5 class="fw-bold mb-3">üéì Academic Details</h5>
    <div class="row">
      <div class="col-md-6 mb-2"><strong>College:</strong> <span id="college">-</span></div>
      <div class="col-md-6 mb-2"><strong>Course:</strong> <span id="course">-</span></div>
      <div class="col-md-6 mb-2"><strong>Branch:</strong> <span id="branch">-</span></div>
      <div class="col-md-6 mb-2"><strong>Year:</strong> <span id="year">-</span></div>
      <div class="col-md-6 mb-2"><strong>Age:</strong> <span id="age">-</span></div>
    </div>
  </div>

  <!-- SKILL GRAPH -->
  <div class="card p-4 mb-4">
    <h5 class="fw-bold mb-3">üìä Skill Graph</h5>
    <canvas id="skillChart" height="120"></canvas>
  </div>

  <!-- PROJECTS -->
  <div class="card p-4 mb-4">
    <h5 class="fw-bold mb-3">üöÄ Projects</h5>
    <div id="userProjects"></div>
  </div>

  <!-- TEAM REQUESTS -->
  <div class="card p-4 mb-4">
    <h5 class="fw-bold mb-3">ü§ù Team Requests</h5>
    <div id="teamRequests"></div>
  </div>

  <!-- SENT REQUESTS -->
  <div class="card p-4 mb-4">
    <h5 class="fw-bold mb-3">üì§ My Sent Requests</h5>
    <div id="myRequests"></div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
const params = new URLSearchParams(window.location.search);
let userId = params.get("id");
let skillChart;

/* ===========================
   DRAW SKILL GRAPH (FIXED)
=========================== */
function drawGraph(skills){

  const ctx = document.getElementById("skillChart");
  if (!ctx) return;

  // üî• SAFE destroy (error-proof)
  if (window.skillChart && typeof window.skillChart.destroy === "function") {
    window.skillChart.destroy();
  }

  if (!skills || typeof skills !== "object") {
    skills = {};
  }

  window.skillChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: Object.keys(skills).length
        ? Object.keys(skills)
        : ["No Skills"],
      datasets: [{
        label: "Skill Strength",
        data: Object.values(skills).length
          ? Object.values(skills)
          : [0],
        backgroundColor: "rgba(79,70,229,0.25)",
        borderColor: "#4f46e5",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100
        }
      }
    }
  });
}

/* ===========================
   LOAD PROFILE
=========================== */
async function loadProfile(){

  const { data:{session} } = await supabaseClient.auth.getSession();

  if(!session){
    alert("Login required");
    window.location.href="index.html";
    return;
  }

  if(!userId) userId = session.user.id;
  const isOwner = session.user.id === userId;

  if(isOwner){
    document.getElementById("chatButton").style.display = "none";
  }

  /* PROFILE DATA */
  const { data:profile } = await supabaseClient
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();

  if(!profile) return;

  document.getElementById("username").innerText = profile.username || "User";
  document.getElementById("collegeInfo").innerText = profile.college || "";

  document.getElementById("college").innerText = profile.college || "-";
  document.getElementById("course").innerText = profile.course || "-";
  document.getElementById("branch").innerText = profile.branch || "-";
  document.getElementById("year").innerText = profile.year || "-";
  document.getElementById("age").innerText = profile.age || "-";

 /* ===========================
   FETCH SKILL SNAPSHOT (LIKE EXPLORE)
=========================== */
const { data: snapshot, error: snapErr } = await supabaseClient
  .from("user_skill_snapshot")
  .select("skills")
  .eq("user_id", userId)
  .single();

if (snapErr) {
  console.error("Snapshot error:", snapErr);
  drawGraph({});
} else {
  drawGraph(snapshot?.skills || {});
}

  /* USER PROJECTS */
  const { data:projects } = await supabaseClient
    .from("projects")
    .select("*")
    .eq("owner_id", userId)
    .order("created_at",{ascending:false});

  const projectBox=document.getElementById("userProjects");
  projectBox.innerHTML="";

  if(!projects || projects.length===0){
    projectBox.innerHTML="<p class='text-muted'>No projects yet</p>";
  } else {
    projects.forEach(p=>{
      projectBox.innerHTML+=`
        <div class="card p-3 mb-2">
          <h6 class="fw-bold">${p.title}</h6>
          <p class="text-muted">${p.description || ""}</p>
        </div>`;
    });
  }

  /* INCOMING REQUESTS */
  const reqBox = document.getElementById("teamRequests");
  reqBox.innerHTML = "";

  if(isOwner){

    const { data:requests } = await supabaseClient
      .from("project_team_requests")
      .select("id, status, from_user, project_id")
      .eq("to_user", session.user.id)
      .order("created_at",{ascending:false});

    if(!requests || requests.length===0){
      reqBox.innerHTML="<p class='text-muted'>No requests yet</p>";
    } else {

      for(const r of requests){

        const { data:sender } = await supabaseClient
          .from("profiles")
          .select("username")
          .eq("id", r.from_user)
          .single();

        const senderName = sender?.username || "User";

        reqBox.innerHTML+=`
          <div class="border rounded p-2 mb-2">
            <strong 
  style="cursor:pointer;color:#4f46e5"
  onclick="openUserProfile('${r.from_user}')">
  ${senderName}
</strong>
            <div class="mt-2">
              ${
                r.status === "pending"
                ? `
                  <button class="btn btn-sm btn-success me-2"
                    onclick="updateRequest('${r.id}','accepted')">Accept</button>
                  <button class="btn btn-sm btn-danger"
                    onclick="updateRequest('${r.id}','rejected')">Reject</button>
                `
                : `<span class="badge bg-secondary">${r.status.toUpperCase()}</span>`
              }
            </div>
          </div>`;
      }
    }
  }

  /* SENT REQUESTS */
  const sentBox = document.getElementById("myRequests");
  sentBox.innerHTML="";

  const { data:sent } = await supabaseClient
    .from("project_team_requests")
    .select("id, status, to_user")
    .eq("from_user", session.user.id)
    .order("created_at",{ascending:false});

  if(!sent || sent.length===0){
    sentBox.innerHTML="<p class='text-muted'>No sent requests</p>";
  } else {

    for(const r of sent){

      const { data:receiver } = await supabaseClient
        .from("profiles")
        .select("username")
        .eq("id", r.to_user)
        .single();

      const receiverName = receiver?.username || "User";

      const badge =
        r.status==="accepted" ? "bg-success" :
        r.status==="rejected" ? "bg-danger" :
        "bg-warning";

      sentBox.innerHTML+=`
        <div class="border rounded p-2 mb-2">
          <strong 
  style="cursor:pointer;color:#4f46e5"
  onclick="openUserProfile('${r.to_user}')">
  To: ${receiverName}
</strong>
          <div class="mt-2">
            <span class="badge ${badge}">
              ${r.status.toUpperCase()}
            </span>
          </div>
        </div>`;
    }
  }
}

async function updateRequest(id,status){

  const { data:{session} } = await supabaseClient.auth.getSession();

  await supabaseClient
    .from("project_team_requests")
    .update({status})
    .eq("id",id)
    .eq("to_user",session.user.id);

  loadProfile();
}

function openChat(){
  console.log("Opening chat with:", userId);
  window.location.href=`project-chat.html?user=${userId}`;
}

loadProfile();
async function goProfile(){
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return alert("Login required");
  window.location.href = `user.html?id=${session.user.id}`;
}
function goProjects(){
  window.location.href = "projects.html";
}
function goInbox(){
  window.location.href = "inbox.html";
}
function goexplore(){
  window.location.href = "explore.html";
}
function openUserProfile(uid){
  window.location.href = `user.html?id=${uid}`;
}
function openUserProfile(uid){
  window.location.href = `user.html?id=${uid}`;
}
</script>
<div class="bottom-nav">
  <div onclick="goProjects()">üè†<span>Projects</span></div>
  <div onclick="goProfile()">üë§<span>Profile</span></div>
  <div onclick="goInbox()">üí¨<span>Chats</span></div>
   <div onclick="goexplore()"><span>explore graphs</span></div>
</div>

</body>
</html>