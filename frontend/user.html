<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile | SkillXpress</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
  font-family:"Segoe UI",sans-serif;
  background:#f3f4f6;
}

.card{
  border:none;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}

.username{
  font-weight:800;
  color:#4f46e5;
}

.chat-btn{
  background:#4f46e5;
  color:white;
  border:none;
  border-radius:12px;
  padding:8px 16px;
}

/* üîª BOTTOM NAV (FIXED) */
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:60px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}

.bottom-nav div{
  text-align:center;
  font-size:20px;
  cursor:pointer;
  color:#555;
}

.bottom-nav span{
  display:block;
  font-size:12px;
}
</style>
</head>

<body>

<div class="container py-4" style="max-width:900px">

  <!-- PROFILE HEADER -->
  <div class="card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h3 id="username" class="username">User</h3>
      <button class="chat-btn" onclick="openChat()">üí¨ Chat</button>
    </div>
  </div>

  <!-- SKILL GRAPH -->
  <div class="card p-4 mb-4">
    <h5 class="fw-bold mb-3">üìä Skill Graph</h5>
    <canvas id="skillChart" height="120"></canvas>
  </div>

  <!-- PROJECTS -->
  <div class="card p-4">
    <h5 class="fw-bold mb-3">üöÄ Projects</h5>
    <div id="userProjects">
      <p class="text-muted">Loading projects...</p>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
/* =======================
   GET USER ID FROM URL
======================= */
const params = new URLSearchParams(window.location.search);
const userId = params.get("id");
console.log("Opened profile ID:", userId);

let skillChart;

/* =======================
   DRAW SKILL GRAPH
======================= */
function drawGraph(skills){
  const ctx = document.getElementById("skillChart");

  if(skillChart) skillChart.destroy();

  const labels = Object.keys(skills);
  const values = Object.values(skills);

  skillChart = new Chart(ctx,{
    type:"radar",
    data:{
      labels: labels.length ? labels : ["No Data"],
      datasets:[{
        label:"Skill Strength",
        data: values.length ? values : [0],
        backgroundColor:"rgba(79,70,229,.3)",
        borderColor:"#4f46e5",
        borderWidth:2
      }]
    },
    options:{
      scales:{ r:{ beginAtZero:true, max:100 } }
    }
  });
}

/* =======================
   LOAD PROFILE DATA
======================= */
async function loadProfile(){

  if(!userId){
    alert("User ID missing");
    return;
  }

  /* PROFILE INFO */
  const { data:profile, error } = await supabaseClient
    .from("profiles")
    .select("id, username, github")
    .eq("id", userId)
    .single();

  if(error || !profile){
    console.error("Profile error:", error);
    alert("Profile not found");
    return;
  }

  document.getElementById("username").innerText =
    profile.username || "User";

  /* SKILLS */
  let gh = null;
  if(profile.github){
    gh = profile.github.includes("github.com")
      ? profile.github.split("github.com/")[1]
      : profile.github;
  }

  if(gh){
    try{
      const res = await fetch(
        `https://skillxpress.onrender.com/full-skills/${userId}/${gh}`
      );
      const skillData = await res.json();
      drawGraph(skillData.skills || {});
    }catch(e){
      drawGraph({});
    }
  }else{
    drawGraph({});
  }

  /* PROJECTS */
  const { data:projects, error:pErr } = await supabaseClient
    .from("projects")
    .select("*")
    .eq("owner_id", userId)
    .order("created_at",{ascending:false});

  const box = document.getElementById("userProjects");
  box.innerHTML = "";

  if(pErr){
    box.innerHTML="<p class='text-danger'>Failed to load projects</p>";
    return;
  }

  if(!projects || projects.length===0){
    box.innerHTML="<p class='text-muted'>No projects yet</p>";
    return;
  }

  projects.forEach(p=>{
    box.innerHTML += `
      <div class="card p-3 mb-3">
        ${p.image_url ? `<img src="${p.image_url}" class="img-fluid rounded mb-2">` : ""}
        <h6 class="fw-bold">${p.title}</h6>
        <p class="text-muted">${p.description || ""}</p>
      </div>
    `;
  });
}

/* =======================
   OPEN CHAT (USER TO USER)
======================= */
function openChat(){
  localStorage.setItem("chatReceiver", userId);
  window.location.href = `project-chat.html?user=${userId}`;
}

/* INIT */
loadProfile();
async function goProfile(){
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) return alert("Login required");
  window.location.href = `user.html?id=${session.user.id}`;
}
function goProjects(){
  window.location.href = "projects.html";
}
function goInbox(){
  window.location.href = "inbox.html";
}

</script>
<!-- üîª BOTTOM NAV -->
<div class="bottom-nav">
  <div onclick="goProjects()">üè†<span>Projects</span></div>
  <div onclick="goProfile()">üë§<span>Profile</span></div>
  <div onclick="goInbox()">üí¨<span>Chats</span></div>
</div>
</body>
</html>
