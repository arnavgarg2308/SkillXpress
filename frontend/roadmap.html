<!DOCTYPE html>
<html>
<head>
<title>AI Roadmap</title>
<style>
body{font-family:sans-serif;background:#eef2ff}
.card{max-width:650px;margin:40px auto;background:#fff;
padding:25px;border-radius:14px;box-shadow:0 15px 40px #0002}
.badge{background:#e0e7ff;padding:6px 12px;border-radius:20px;margin:4px;display:inline-block}
.note{background:#f0f9ff;padding:14px;border-left:4px solid #0ea5e9;margin-top:12px}
button{background:#4f46e5;color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>

<div class="card">
  <h2>üìÖ Monthly AI Roadmap</h2>
  <div id="roadmapBox">Click Generate</div>
  <br/>
  <button id="generateBtn" onclick="generate()">Generate Month</button>
   <br/>
   <br/>
   <button onclick="downloadRoadmap(CURRENT_MONTH)">
  Download Roadmap PDF
</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
let USER_ID = null;
let CURRENT_MONTH = 1; 
/* ‚úÖ page load pe user id nikaalo */
async function initUser() {
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if (!session) {
    alert("Login required");
    return;
  }
  USER_ID = session.user.id;
}

initUser();

/* ‚úÖ button ye function call karega */
async function generate() {
  if (!USER_ID) {
    alert("User not loaded yet or session expired");
    console.log("USER_ID:", USER_ID);
    return;
  }
 const btn = document.getElementById("generateBtn");
  btn.innerText = "Generating... Please wait";
  btn.disabled = true;
  document.getElementById("roadmapBox").innerHTML =
    "<p>‚è≥ Generating your AI roadmap...please wait 5 mins </p>";
  try {
    const res = await fetch("https://skillxpress-1.onrender.com/api/roadmap/generate-month", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: USER_ID })
    });

    const data = await res.json();
    console.log("API Response:", data);

    if (!data.success) {
      document.getElementById("roadmapBox").innerHTML =
        `<p style="color:red">${data.error}</p>`;
      return;
    }

    const r = data.roadmap;
CURRENT_MONTH = r.month; 
    document.getElementById("roadmapBox").innerHTML = `
      <h3>Month ${r.month} ‚Äì ${r.role}</h3>
      <pre style="white-space:pre-wrap; line-height:1.6;">
${r.content}
      </pre>
    `;
  } catch (err) {
    console.error("Fetch error:", err);
  }
   btn.innerText = "Generate Month";
  btn.disabled = false;
}
async function downloadRoadmap(month) {

  if (!USER_ID) {
    alert("User not loaded yet");
    return;
  }

  const res = await fetch(
    `https://skillxpress-1.onrender.com/api/roadmap/download-pdf/${USER_ID}/${month}`
  );

  const data = await res.json();

  if (data.url) {
    window.open(data.url, "_blank");
  } else {
    alert("PDF not found");
  }
}
</script>

</body>
</html>
